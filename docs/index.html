<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parametrics Reports</title>
  <meta name="description" content="Paragliding IGC analytics reports generated by Parametrics." />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root { --brand:#03a9f4; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#222; margin:0; }
    header { padding: 28px 16px; border-bottom: 1px solid #eee; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; color: var(--brand); font-weight: 700; letter-spacing:.2px; }
    p.lead { margin:0; color:#555; }
    #controls { display:flex; gap:8px; align-items:center; margin:18px 0 8px; flex-wrap:wrap; }
    input[type="search"] { flex:1; min-width:220px; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    select { padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    ul.list { list-style:none; padding:0; margin:10px 0 48px; }
    .card { padding:14px 16px; border:1px solid #eee; border-radius:14px; margin:10px 0; display:flex; justify-content:space-between; align-items:center; transition: box-shadow .15s ease; }
    .card:hover { box-shadow:0 6px 20px rgba(0,0,0,.06); }
    .meta { font-size:14px; color:#666; margin-top:4px; }
    a.btn { text-decoration:none; padding:10px 14px; border:1px solid var(--brand); color:var(--brand); border-radius:12px; font-weight:600; }
    a.btn:hover { background: var(--brand); color:#fff; }
    footer { border-top:1px solid #eee; padding:18px 0; color:#777; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Parametrics Reports</h1>
      <p class="lead">Browse public IGC analytics reports. New reports appear automatically as you add them to this repo.</p>
    </div>
  </header>

  <main class="wrap">
    <div id="controls">
      <input id="q" type="search" placeholder="Search by pilot, site or date…" />
      <select id="sort">
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="alpha">A → Z</option>
      </select>
    </div>

    <ul id="list" class="list"></ul>
    <div id="empty" style="display:none; color:#777; margin:16px 0;">No reports found.</div>
  </main>

  <footer>
    <div class="wrap">© <span id="year"></span> Parametrics • <a href="https://parametrics.app" target="_blank" rel="noopener">parametrics.app</a></div>
  </footer>

  <script>
    // ---- CONFIG: update if you rename repo/branch/path
    const OWNER = "RiaMoothilal";
    const REPO  = "IGCAnalyticsOutput";
    const BRANCH = "master";          // or 'main'
    const BASE_PATH = "docs";         // GitHub Pages is serving from /docs in this repo

    // Fetch the full tree once, filter client-side
    async function fetchTree() {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${BRANCH}?recursive=1`;
      const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" }});
      if (!res.ok) throw new Error("GitHub API error: " + res.status);
      const data = await res.json();
      return data.tree || [];
    }

    // Heuristics: include HTML files under /docs/** that are report entry points
    function isReportPath(path) {
      if (!path.startsWith(BASE_PATH + "/")) return false;
      if (path.includes("/index_files/")) return false;   // skip assets
      // Prefer …/index.html (Quarto/Rmd default). Allow other .html too.
      return path.endsWith("/index.html") || (path.endsWith(".html") && !path.endsWith("/index.html") && !path.endsWith("index.html"));
    }

    // Derive label info from your folder structure: docs/<pilot>/<date-site>/index.html
    function parseMeta(path) {
      // Remove leading "docs/"
      const rel = path.replace(/^docs\//, "");
      const parts = rel.split("/");
      let pilot = parts[0] || "";
      let flightKey = parts.slice(1, - (path.endsWith("index.html") ? 1 : 0)).join("/") || parts[0];

      // Attempt to extract date (YYYY-MM-DD) if present
      const dateMatch = rel.match(/\b(20\d{2}-\d{2}-\d{2})\b/);
      const date = dateMatch ? dateMatch[1] : "";

      // Create a nice title
      const nice = rel
        .replace(/\/index\.html$/, "")
        .replace(/-/g, " ")
        .replace(/\b\w/g, c => c.toUpperCase());

      return { rel, pilot, date, nice };
    }

    function buildURL(path) {
      // On Pages served from /docs, request path should be relative to domain root.
      // e.g., docs/andi/2025-09-02-unknown/index.html -> /andi/2025-09-02-unknown/
      const rel = path.replace(/^docs\//, "");
      // If index.html, drop it for cleaner URLs
      return "/" + rel.replace(/\/index\.html$/, "/");
    }

    function render(list) {
      const ul = document.getElementById("list");
      const empty = document.getElementById("empty");
      ul.innerHTML = "";
      if (!list.length) { empty.style.display = "block"; return; }
      empty.style.display = "none";

      for (const item of list) {
        const li = document.createElement("li");
        li.className = "card";
        li.innerHTML = `
          <div>
            <div style="font-weight:700">${item.meta.nice}</div>
            <div class="meta">
              ${item.meta.pilot ? `Pilot: ${item.meta.pilot}` : ""} 
              ${item.meta.pilot && item.meta.date ? " • " : ""} 
              ${item.meta.date ? `Date: ${item.meta.date}` : ""}
            </div>
          </div>
          <a class="btn" href="${item.url}">Open</a>
        `;
        ul.appendChild(li);
      }
    }

    function sortList(list, mode) {
      if (mode === "alpha") {
        list.sort((a,b) => a.meta.nice.localeCompare(b.meta.nice));
      } else if (mode === "oldest") {
        list.sort((a,b) => (a.meta.date || "0000").localeCompare(b.meta.date || "0000"));
      } else {
        // newest first (default)
        list.sort((a,b) => (b.meta.date || "0000").localeCompare(a.meta.date || "0000"));
      }
    }

    function filterList(list, q) {
      if (!q) return list;
      const s = q.toLowerCase();
      return list.filter(x =>
        x.meta.nice.toLowerCase().includes(s) ||
        x.meta.pilot.toLowerCase().includes(s) ||
        x.meta.date.toLowerCase().includes(s)
      );
    }

    async function main() {
      document.getElementById("year").textContent = new Date().getFullYear();
      try {
        const tree = await fetchTree();
        const reports = tree
          .filter(n => n.type === "blob" && isReportPath(n.path))
          .map(n => {
            const meta = parseMeta(n.path);
            return { path: n.path, meta, url: buildURL(n.path) };
          });

        const sortSel = document.getElementById("sort");
        const search = document.getElementById("q");

        function update() {
          const q = search.value.trim();
          const mode = sortSel.value;
          const filtered = filterList(reports, q);
          const sorted = [...filtered];
          sortList(sorted, mode);
          render(sorted);
        }

        sortSel.addEventListener("change", update);
        search.addEventListener("input", update);
        update();
      } catch (e) {
        console.error(e);
        document.getElementById("empty").style.display = "block";
        document.getElementById("empty").textContent = "Could not load reports from GitHub.";
      }
    }
    main();
  </script>
</body>
</html>
